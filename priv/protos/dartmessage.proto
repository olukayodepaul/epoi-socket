syntax = "proto3";

package bimip;

// ---------------- Identity ----------------
// Represents a user and optionally a specific device/session
message Identity {
  string eid = 1;                               // User’s global identifier (e.g., account ID or JID)
  optional string connection_resource_id = 2;   // Identifier for a specific device or session instance
}

// ---------------- AwarenessNotification ----------------
// Sends a user’s awareness (presence, location, and status) to other users
message AwarenessNotification {
  Identity from = 1;                 // Sender (uses eid only)
  Identity to = 2;                   // Recipient (uses eid only)
  int32 status = 3;                  // Presence state: 1=ONLINE, 2=OFFLINE, 3=AWAY, 4=BUSY, 5=DND, 6=INVISIBLE, 7=IDLE, 8=UNKNOWN
  int64 last_seen = 4;               // Last active time (Unix UTC, ms)
  double latitude = 5;               // Latitude
  double longitude = 6;              // Longitude
  int32 awareness_intention = 7;     // Broadcast control: 1=DO_NOT_BROADCAST, 2=BROADCAST
}

// ---------------- ErrorMessage ----------------
// Represents an error response with code, description, and optional details
message ErrorMessage {
  int32 code = 1;       // Numeric error code
  string message = 2;   // Short error description
  string route = 3;     // Route or context where the error occurred
  string details = 4;   // Additional error details (optional)
}

// ---------------- LogoutMessage ----------------
// Uses both eid and connection_resource_id to log out a specific device
message Logout {
  Identity to = 1;      // The user/device performing logout
  int32 type = 2;           // 1 = REQUEST, 2 = RESPONSE
  int32 status = 3;         // 1 = DISCONNECT, 2 = FAIL, 3 = SUCCESS, 4 = PENDING
  int64 timestamp = 4;      // Unix UTC timestamp (ms) of the action
}

// ---------------- PingPong ----------------
// Heartbeat messages from client to server to check connectivity of a specific device (Identity includes both eid and connection_resource_id)
// Client generates ping_id; server echoes it back in PONG with pong_time
message PingPong {
  Identity to = 1;              // Server identity, includes both eid and connection_resource_id to identify the target device/session
  int32 type = 2;               // Message type: 1=PING (from client), 2=PONG (from server)
  int64 ping_time = 3;          // Timestamp when client sent the PING (Unix UTC, ms)
  int64 pong_time = 4;          // Timestamp when server sent the PONG (Unix UTC, ms)
  string ping_id = 5;           // Unique identifier for this PING, generated by client and echoed in PONG
}

// ---------------- TokenRevokeRequest ----------------
// Client requests to revoke a specific token (e.g., for logout, security, or device change).
// `to` specifies the server/device responsible for revoking.
// `reason` is optional but useful for auditing and explaining forced revokes.

message TokenRevokeRequest {
  Identity to     = 1;
  string token    = 2;
  int64 timestamp = 3;
  string reason   = 4;   // e.g., "LOGOUT", "COMPROMISED", "SESSION_EXPIRED"
}

message TokenRevokeResponse {
  Identity to = 1;
  int32 status = 2;       // 1=SUCCESS, 2=FAILED
  int64 timestamp = 3;
  string reason = 4;      // optional: provides explanation if status=FAILED
}


// ---------------- SubscribeRequest ----------------
// Used when a user (`from`) requests to subscribe to another user’s presence/updates.
// NOTE: `from` and `to` MUST only use `eid`. 
// The `connection_resource_id` MUST be nil (not set).
message SubscribeRequest {
  Identity from = 1;          // The user initiating the subscription (eid only)
  Identity to = 2;            // The user being subscribed to (eid only)
  string group = 3;           // Optional grouping/category (e.g., "Family", "Work")
  int64 timestamp = 4;        // Time the request was created
}

// ---------------- SubscribeResponse ----------------
// Sent back to confirm whether the subscription request succeeded or failed.
// NOTE: `from` and `to` MUST only use `eid`. 
// The `connection_resource_id` MUST be nil (not set).
message SubscribeResponse {
  Identity from = 1;          // The requester (eid only)
  Identity to = 2;            // The target being subscribed to (eid only)
  int32 status = 3;           // 1=SUCCESS, 2=FAILED
  string message = 4;         // Human-readable status info
  int64 timestamp = 5;        // Time the response was generated
}


// ---------------- UnsubscribeRequest ----------------
// Used when a user (`from`) unsubscribes from another user (`to`) to stop receiving updates.
// NOTE: `from` and `to` MUST only use `eid`.
// The `connection_resource_id` MUST be nil (not set).
message UnsubscribeRequest {
  Identity from = 1;          // The user initiating the unsubscribe (eid only)
  Identity to = 2;            // The user being unsubscribed from (eid only)
  int64 timestamp = 3;        // Time the request was created
}

// ---------------- UnsubscribeResponse ----------------
// Sent back to confirm whether the unsubscribe succeeded or failed.
// NOTE: `from` and `to` MUST only use `eid`.
// The `connection_resource_id` MUST be nil (not set).
message UnsubscribeResponse {
  Identity from = 1;          // The requester (eid only)
  Identity to = 2;            // The target being unsubscribed from (eid only)
  int32 status = 3;           // 1=SUCCESS, 2=FAILED
  string message = 4;         // Human-readable status info
  int64 timestamp = 5;        // Time the response was generated
}




// ---------------- MessageScheme ----------------
// Wrapper for all messaging protocol types
message MessageScheme {
  int64 route = 1;  // Unique route identifier for message routing

  oneof payload {
    AwarenessNotification awareness_notification  = 1;  // User awareness/presence update
    //2-3
    PingPong ping_pong                            = 4;
    TokenRevokeRequest token_revoke_request       = 5;
    TokenRevokeResponse token_revoke_response     = 6;
    SubscribeRequest subscribe_request            = 7;
    SubscribeResponse subscribe_response          = 8;
    UnsubscribeRequest unsubscribe_request        = 9;
    UnsubscribeResponse unsubscribe_response      = 10;
    Logout logout                                 = 11; // Logout message
    ErrorMessage error                            = 12; // Error message
  }
}